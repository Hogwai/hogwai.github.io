---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header';
import Footer from '../components/Footer';
import TableOfContents from '../components/TableOfContents';
import BackToTop from '../components/BackToTop';
import { type CollectionEntry } from 'astro:content';

type Props = CollectionEntry<'posts'>['data'] & {
  headings?: Array<{ depth: number; slug: string; text: string }>;
  minutesRead?: string;
};

const { title, description, pubDate, updatedDate, heroImage, tags, headings = [], minutesRead } = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const imageURL = heroImage ? new URL(heroImage, Astro.site).href : undefined;

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: description,
  datePublished: pubDate.toISOString(),
  ...(updatedDate && { dateModified: updatedDate.toISOString() }),
  ...(imageURL && { image: imageURL }),
  url: canonicalURL.href,
  author: {
    "@type": "Person",
    name: "Lilian",
  },
  publisher: {
    "@type": "Organization",
    name: "Hogwai Tech Blog",
  },
};

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: Astro.site?.href ?? "https://hogwai.github.io",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Posts",
      item: new URL("/posts/", Astro.site).href,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: title,
      item: canonicalURL.href,
    },
  ],
};
---

<BaseLayout title={title} description={description} image={heroImage}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
  </Fragment>
  <Header client:visible />
  
  <main id="main-content" class="flex-grow bg-page">
    <article class="container-custom py-12">
      <div class="mb-8">
        {heroImage && (
          <img
            src={heroImage}
            alt={title}
            loading="lazy"
            decoding="async"
            class="w-full h-64 object-cover rounded-lg mb-6"
          />
        )}
        
        <h1 class="text-4xl md:text-5xl font-bold mb-4 text-ink">{title}</h1>
        
        <div class="flex flex-wrap items-center gap-3 mb-4 text-sm text-ink">
          <a href="/posts" class="hover:text-link transition">
            ← Posts
          </a>
          <span>•</span>
          <time datetime={pubDate.toISOString()}>
            {pubDate.toLocaleDateString('en-GB', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
          {updatedDate && (
            <>
              <span>•</span>
              <time datetime={updatedDate.toISOString()}>
                Updated {updatedDate.toLocaleDateString('en-GB', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
              </time>
            </>
          )}
          {minutesRead && (
            <>
              <span>•</span>
              <span>{minutesRead}</span>
            </>
          )}
        </div>
        
        {tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {tags.map((tag) => (
              <a href={`/tags/${tag}`} class="px-3 py-1 bg-tag-bg text-tag-text rounded-full text-sm hover:underline">
                {tag}
              </a>
            ))}
          </div>
        )}
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div class="lg:col-span-3 prose prose max-w-none">
          <slot />
        </div>
        
        <aside class="lg:col-span-1">
          <div class="sticky top-24 h-fit">
            <TableOfContents headings={headings} client:idle />
          </div>
        </aside>
      </div>
    </article>
  </main>
  
  <BackToTop client:idle />
  <Footer />
</BaseLayout>
